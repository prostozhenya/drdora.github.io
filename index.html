<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>–° –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è, –î–∞—à–∞ üíñ</title>
<style>
/* –®—Ä–∏—Ñ—Ç—ã/–±–∞–∑ */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
:root{
  --bg1:#1a0f2c; --bg2:#2c1f4d;
  --accent1: rgba(180,155,250,0.95);
  --accent2: rgba(120,90,220,0.85);
  --glass: rgba(255,255,255,0.06);
  --naruto-glow: rgba(255, 165, 0, 0.6);
  --sakura-glow: rgba(255, 105, 180, 0.6);
  --wanpis-glow: rgba(220, 20, 60, 0.6);
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; padding:0; font-family:'Poppins',sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
body{
  /* —É—á—ë—Ç –≤—ã—Ä–µ–∑–æ–≤: */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  overflow:hidden;
  display:flex;
  align-items:stretch;
  justify-content:center;
}

/* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã */
.app {
  position:relative;
  width:100%;
  max-width:1200px;
  height:100vh;
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–≤–µ—Ä—Ö—É, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ */
h1 {
  position:absolute;
  top: calc(8px + env(safe-area-inset-top));
  left:50%;
  transform:translateX(-50%);
  z-index:40;
  margin:0;
  padding:6px 12px;
  font-weight:600;
  font-size: clamp(1.4rem, 3.6vw, 2.6rem);
  color:#cda4ff;
  text-shadow:0 0 10px #b080ff, 0 0 30px #a060ff;
  pointer-events:none;
  white-space:nowrap;
}

/* –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–Ω—Ç—Ä ‚Äî –∫–Ω–æ–ø–∫–∞ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ */
.center {
  width:100%;
  padding: 12vh 20px 12vh 20px; /* –¥–∞—ë–º –º–µ—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events: none; /* —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å pointer-events –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è */
}

/* –ü–ª–µ–π –∫–Ω–æ–ø–∫–∞ ‚Äî –≤–∏–∑—É–∞–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä, –Ω–æ pointer-events –≤–∫–ª—é—á–µ–Ω—ã */
#playButton {
  pointer-events: auto;
  z-index: 30;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding: clamp(10px, 3.2vw, 16px) clamp(20px, 6vw, 40px);
  font-size: clamp(1rem, 3.2vw, 1.25rem);
  border-radius: 28px;
  border: none;
  background: var(--glass);
  color: #fff;
  backdrop-filter: blur(12px) saturate(160%);
  box-shadow: 0 0 26px rgba(120,90,220,0.55);
  cursor: pointer;
  transition: transform .16s ease, opacity .35s ease;
}
#playButton:active{ transform: scale(.98); }
#playButton.hidden{ opacity:0; transform:scale(.92); pointer-events:none; }

/* –§–ª–∞–≥ –∏ –ø–µ—á–µ–Ω—å–∫–∞ ‚Äî –ø–ª–∞–≤–Ω—ã–µ –≥–∏–±–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã */
.flag, .cookie, .character {
  position:absolute;
  z-index:20;
  filter: drop-shadow(0 0 12px rgba(120,90,220,0.7)) drop-shadow(0 0 26px rgba(180,155,250,0.35));
  transition: transform .9s cubic-bezier(.2,.9,.2,1), opacity .9s ease;
  pointer-events:none;
  will-change:transform,opacity;
}

/* —Ñ–ª–∞–≥ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É */
.flag {
  top: 18%;
  right: clamp(12px, 6vw, 6%);
  width: clamp(120px, 22vw, 220px);
  transform-origin: left center;
  animation: flagAppear .9s ease forwards .6s, flagWave 5s ease-in-out infinite 2s;
}
@keyframes flagAppear{ from{ transform: translateY(-18px) scale(.96); opacity:0 } to{ transform: translateY(0) scale(1); opacity:1 } }
@keyframes flagWave{
  0%{ transform: rotateZ(-2deg) skewY(0deg) } 25%{ transform: rotateZ(2deg) skewY(2deg) } 50%{ transform: rotateZ(-1deg) skewY(-2deg) } 75%{ transform: rotateZ(1deg) skewY(1deg) } 100%{ transform: rotateZ(-2deg) skewY(0deg) }
}

/* –ø–µ—á–µ–Ω—å–∫–∞ —Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É */
.cookie {
  left: clamp(8px, 6vw, 6%);
  bottom: clamp(8px, 10vh, 18%);
  width: clamp(70px, 18vw, 120px);
  animation: cookieAppear .9s ease forwards 1.1s, cookieFloat 6s ease-in-out infinite 3s;
}
@keyframes cookieAppear{ from{ transform: translateY(10px) scale(.94); opacity:0 } to{ transform: translateY(0) scale(1); opacity:1 } }
@keyframes cookieFloat{
  0%,100%{ transform: translateY(0) rotate(0deg) scale(1) } 25%{ transform: translateY(-8px) rotate(-6deg) scale(1.03) } 50%{ transform: translateY(0) rotate(4deg) scale(1) } 75%{ transform: translateY(6px) rotate(-4deg) scale(1.02) }
}

/* –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –ù–∞—Ä—É—Ç–æ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ */
.naruto-character {
  width: clamp(85px, 17vw, 160px);
  animation: characterAppear .9s ease forwards, characterFloat 7s ease-in-out infinite;
  border-radius: 20px;
  backdrop-filter: blur(8px) saturate(180%);
  background: rgba(255,255,255,0.03);
  padding: 8px;
  box-shadow: 
    0 0 25px var(--char-glow, rgba(180,155,250,0.6)),
    inset 0 0 20px rgba(255,255,255,0.1);
}

/* –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ü–≤–µ—Ç–∞ */
#naruto {
  top: 12%;
  left: 4%;
  --char-glow: var(--naruto-glow);
  animation-delay: 0.7s, 2.2s;
}

#sakura {
  bottom: 15%;
  right: 6%;
  --char-glow: var(--sakura-glow);
  animation-delay: 0.9s, 2.8s;
}

#wanpis {
  bottom: 28%;
  left: 10%;
  --char-glow: var(--wanpis-glow);
  animation-delay: 1.1s, 3.4s;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π */
@keyframes characterAppear{ 
  from{ 
    transform: translateY(25px) scale(.85) rotate(-5deg); 
    opacity:0;
    filter: drop-shadow(0 0 0px transparent);
  } 
  to{ 
    transform: translateY(0) scale(1) rotate(0deg); 
    opacity:1;
    filter: drop-shadow(0 0 15px var(--char-glow)) drop-shadow(0 0 30px rgba(180,155,250,0.4));
  } 
}

@keyframes characterFloat{
  0%,100%{ 
    transform: translateY(0) rotate(0deg) scale(1);
    box-shadow: 
      0 0 25px var(--char-glow),
      inset 0 0 20px rgba(255,255,255,0.1);
  } 
  25%{ 
    transform: translateY(-15px) rotate(-2deg) scale(1.05);
    box-shadow: 
      0 0 35px var(--char-glow),
      inset 0 0 25px rgba(255,255,255,0.15);
  } 
  50%{ 
    transform: translateY(-8px) rotate(1deg) scale(1.02);
    box-shadow: 
      0 0 28px var(--char-glow),
      inset 0 0 22px rgba(255,255,255,0.12);
  } 
  75%{ 
    transform: translateY(-12px) rotate(-1deg) scale(1.04);
    box-shadow: 
      0 0 32px var(--char-glow),
      inset 0 0 24px rgba(255,255,255,0.14);
  }
}

/* –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π */
@keyframes characterPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.9; }
}

.naruto-character::before {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  border-radius: 24px;
  background: conic-gradient(
    from 0deg at 50% 50%,
    var(--char-glow) 0%,
    transparent 30%,
    transparent 70%,
    var(--char-glow) 100%
  );
  z-index: -1;
  opacity: 0.4;
  animation: rotateBorder 8s linear infinite;
}

@keyframes rotateBorder {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* –µ–¥–∏–Ω—ã–π hide: –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.flag.hide, .cookie.hide, .character.hide {
  opacity: 0;
  transform: translateY(-80px) rotate(-8deg) scale(.78);
  pointer-events:none;
}

/* Canvas —ç–∫–≤–∞–ª–∞–π–∑–µ—Ä–∞ */
#equalizer {
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width: min(94%, 920px);
  bottom: clamp(20px, 7vh, 60px);
  height: clamp(64px, 12vh, 120px);
  border-radius:20px;
  background: rgba(30,20,50,0.12);
  backdrop-filter: blur(20px) saturate(160%);
  box-shadow: 0 0 30px rgba(180,155,250,0.5), inset 0 0 20px rgba(120,90,220,0.2);
  overflow:hidden;
  z-index:18;
}
#equalizerCanvas{ width:100%; height:100%; display:block; }

/* –§–æ—Ç–æ-–ø—É–∑—ã—Ä—å–∫–∏ */
.photo {
  position:absolute;
  width: clamp(64px, 12vw, 120px);
  height: clamp(64px, 12vw, 120px);
  object-fit:cover;
  border-radius:16px;
  box-shadow: 0 0 20px rgba(180,155,250,0.85), 0 0 36px rgba(120,90,220,0.45);
  pointer-events:none;
  transform: translate(-50%,-50%);
  transition: transform .28s ease, opacity .28s ease;
  z-index:22;
}

/* –°–Ω–µ–∂–∏–Ω–∫–∏ */
.snowflake{ position:fixed; top:-10px; user-select:none; pointer-events:none; opacity:.6; font-size:12px; animation: fall linear infinite; color:#fff }
@keyframes fall{ to{ transform: translateY(110vh) rotate(360deg) } }

/* Footer */
footer{
  position:absolute;
  bottom:8px;
  left:50%;
  transform:translateX(-50%);
  z-index:12;
  font-size: clamp(11px, 2.4vw, 14px);
  color:#b080ff;
  text-align:center;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Å—ã–ª–∫–∏ Telegram */
.telegram-link {
  color: #cda4ff !important;
  text-decoration: none;
  margin: 0 6px;
  transition: all 0.3s ease;
  display: inline-block;
}

.telegram-link:hover {
  color: #ffffff !important;
  text-shadow: 0 0 10px #b080ff, 0 0 20px #a060ff;
  transform: translateY(-1px);
}

/* –≠—Ñ—Ñ–µ–∫—Ç—ã —á–∞—Å—Ç–∏—Ü –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π */
.character-particle {
  position: absolute;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 19;
  animation: particleFloat 3s ease-in-out infinite;
}

@keyframes particleFloat {
  0%, 100% { 
    transform: translateY(0) translateX(0);
    opacity: 0;
  }
  10% { 
    opacity: 1;
  }
  90% { 
    opacity: 0;
  }
  100% { 
    transform: translateY(-40px) translateX(20px);
  }
}

/* Media tweaks: phones & tablets */
@media (max-width: 900px){
  .flag{ top:14%; }
  .cookie{ bottom:10%; }
  .naruto-character { 
    width: clamp(75px, 15vw, 130px); 
    padding: 6px;
  }
  #naruto { top: 10%; left: 2%; }
  #sakura { bottom: 12%; right: 4%; }
  #wanpis { bottom: 24%; left: 6%; }
  h1{ font-size: clamp(1.2rem, 5.5vw, 1.6rem) }
  .center{ padding-top: 8vh; padding-bottom: 8vh; }
  
  .naruto-character::before {
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border-radius: 20px;
  }
}
@media (max-width: 430px){
  #playButton{ font-size: clamp(.95rem, 4.2vw, 1rem); padding:12px 18px; }
  .flag{ width: clamp(110px, 28vw, 150px); right:6% }
  .cookie{ width: clamp(60px,18vw,80px); left:5% }
  .naruto-character { 
    width: clamp(65px, 13vw, 100px); 
    padding: 4px;
    border-radius: 16px;
  }
  #equalizer{ height: clamp(56px, 11vh, 80px); bottom:28px }
  .photo{ border-radius:12px; }
  
  .naruto-character::before {
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 18px;
  }
}

/* –ø–ª–∞–Ω—à–µ—Ç–Ω–∞—è –∞–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ‚Äî –¥–∞—ë–º —á—É—Ç—å –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
@media (min-width: 900px) and (max-height:600px){
  .center{ padding-top: 6vh; padding-bottom: 6vh; }
  #playButton{ margin-top: 0; }
  .naruto-character { width: clamp(70px, 12vw, 110px); }
}

/* –ó–∞–ø–∞—Å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
.fallback-image {
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(120,90,220,0.2);
  border: 2px dashed rgba(180,155,250,0.5);
  color: #cda4ff;
  font-size: 12px;
  text-align: center;
}
</style>
</head>
<body>
  <div class="app" id="app">
    <h1 id="title">–° –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è, –î–∞—à–∞ üéÇüí´</h1>

    <div class="center" aria-hidden="false">
      <button id="playButton" aria-label="–ó–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É">–ù–∞–∂–º–∏ üéµ</button>
    </div>

    <!-- –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <img class="flag" id="flag" src="images/flag.png" alt="—Ñ–ª–∞–≥" onerror="this.onerror=null; this.classList.add('fallback-image'); this.style.display='none';">
    <img class="cookie" id="cookie" src="images/cookie.png" alt="–ø–µ—á–µ–Ω—å–∫–∞" onerror="this.onerror=null; this.classList.add('fallback-image'); this.style.display='none';">

    <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –ù–∞—Ä—É—Ç–æ -->
    <img class="character naruto-character" id="naruto" src="images/naruto.png" alt="–ù–∞—Ä—É—Ç–æ" onerror="this.onerror=null; this.classList.add('fallback-image'); this.style.display='none';">
    <img class="character naruto-character" id="sakura" src="images/sakura.png" alt="–°–∞–∫—É—Ä–∞ –•–∞—Ä—É–Ω–æ" onerror="this.onerror=null; this.classList.add('fallback-image'); this.style.display='none';">
    <img class="character naruto-character" id="wanpis" src="images/wanpis.png" alt="–í–∞–Ω –ü–∏—Å" onerror="this.onerror=null; this.classList.add('fallback-image'); this.style.display='none';">

    <audio id="bgm" loop playsinline preload="auto">
      <source src="music/papa_temnogo_princa.mp3" type="audio/mpeg">
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
    </audio>

    <div id="equalizer" aria-hidden="true">
      <canvas id="equalizerCanvas" role="img" aria-label="–≠–∫–≤–∞–ª–∞–π–∑–µ—Ä"></canvas>
    </div>

    <footer>
      designed by <b>prostozhenyaaa</b><br>
      <a href="https://t.me/prostozhenya" class="telegram-link" target="_blank">Telegram</a>
    </footer>
  </div>

<script>
/* --------- –õ–æ–≥–∏–∫–∞ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π canvas + –Ω–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç –∞—É–¥–∏–æ) ---------- */

const app = document.getElementById('app');
const playButton = document.getElementById('playButton');
const flag = document.getElementById('flag');
const cookie = document.getElementById('cookie');
const naruto = document.getElementById('naruto');
const sakura = document.getElementById('sakura');
const wanpis = document.getElementById('wanpis');
const bgm = document.getElementById('bgm');
const equalizer = document.getElementById('equalizer');
const canvas = document.getElementById('equalizerCanvas');
const ctx = canvas.getContext('2d');

// –ó–∞–ø–∞—Å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
const photos = [
  "images/dasha1.jpg","images/dasha2.jpg","images/dasha3.jpg",
  "images/dasha4.jpg","images/dasha5.jpg"
];

// –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∞—Å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
const fallbackImages = [];
for(let i = 1; i <= 5; i++) {
  const canvas = document.createElement('canvas');
  canvas.width = 200;
  canvas.height = 200;
  const ctx = canvas.getContext('2d');
  
  // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
  const gradient = ctx.createLinearGradient(0, 0, 200, 200);
  gradient.addColorStop(0, '#8a2be2');
  gradient.addColorStop(1, '#4b0082');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 200, 200);
  
  // –¢–µ–∫—Å—Ç
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 24px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(`–î–∞—à–∞ ${i}`, 100, 100);
  
  ctx.font = '16px Arial';
  ctx.fillText('üéÇ –° –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è!', 100, 140);
  
  fallbackImages.push(canvas.toDataURL());
}

// –ó–∞–ø–∞—Å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
const characterFallbacks = {
  naruto: createCharacterFallback('–ù–∞—Ä—É—Ç–æ', '#ff6b00'),
  sakura: createCharacterFallback('–°–∞–∫—É—Ä–∞', '#ff1493'),
  wanpis: createCharacterFallback('–í–∞–Ω –ü–∏—Å', '#ff0000')
};

function createCharacterFallback(name, color) {
  const canvas = document.createElement('canvas');
  canvas.width = 150;
  canvas.height = 150;
  const ctx = canvas.getContext('2d');
  
  // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
  const gradient = ctx.createLinearGradient(0, 0, 150, 150);
  gradient.addColorStop(0, color);
  gradient.addColorStop(1, '#8a2be2');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 150, 150);
  
  // –¢–µ–∫—Å—Ç
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 16px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(name, 75, 75);
  
  return canvas.toDataURL();
}

let audioCtx = null;
let source = null;
let analyser = null;
let dataArray = null;
let rafId = null;
let spawnInterval = null;
let particleInterval = null;
let started = false;

/* –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü –≤–æ–∫—Ä—É–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π */
function createCharacterParticles() {
  const characters = [naruto, sakura, wanpis];
  
  characters.forEach(character => {
    if (!character.parentElement) return;
    
    const rect = character.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    // –°–æ–∑–¥–∞–µ–º 2-3 —á–∞—Å—Ç–∏—Ü—ã –∑–∞ —Ä–∞–∑
    for(let i = 0; i < 2 + Math.floor(Math.random() * 2); i++) {
      const particle = document.createElement('div');
      particle.className = 'character-particle';
      
      // –¶–≤–µ—Ç —á–∞—Å—Ç–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      let particleColor;
      if (character.id === 'naruto') particleColor = 'rgba(255, 165, 0, 0.7)';
      else if (character.id === 'sakura') particleColor = 'rgba(255, 105, 180, 0.7)';
      else particleColor = 'rgba(220, 20, 60, 0.7)';
      
      particle.style.background = particleColor;
      particle.style.boxShadow = `0 0 8px ${particleColor}`;
      
      // –°–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –≤–æ–∫—Ä—É–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      const angle = Math.random() * Math.PI * 2;
      const distance = 30 + Math.random() * 40;
      const startX = centerX + Math.cos(angle) * distance;
      const startY = centerY + Math.sin(angle) * distance;
      
      particle.style.left = startX + 'px';
      particle.style.top = startY + 'px';
      particle.style.animationDelay = Math.random() * 2 + 's';
      
      document.body.appendChild(particle);
      
      // –£–¥–∞–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      setTimeout(() => {
        if (particle.parentElement) {
          particle.remove();
        }
      }, 3000);
    }
  });
}

/* –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ—Å–∞–π–∑ canvas: –∏—Å–ø–æ–ª—å–∑—É–µ–º getBoundingClientRect() */
function resizeCanvas(){
  const rect = equalizer.getBoundingClientRect();
  const w = Math.max(1, Math.round(rect.width));
  const h = Math.max(1, Math.round(rect.height));
  const DPR = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.round(w * DPR);
  canvas.height = Math.round(h * DPR);
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(DPR, DPR);
}
window.addEventListener('resize', () => {
  // debounce-ish: –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç
  clearTimeout(window._eqResizeTimer);
  window._eqResizeTimer = setTimeout(resizeCanvas, 80);
});
resizeCanvas();

/* audio setup */
function setupAudio(){
  if(audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaElementSource(bgm);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 128;
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    console.log('AudioContext created');
  } catch (err) {
    console.warn('AudioContext error:', err);
  }
}

/* draw equalizer */
function drawWave(){
  rafId = requestAnimationFrame(drawWave);
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArray);
  const rect = equalizer.getBoundingClientRect();
  const width = rect.width;
  const height = rect.height;
  ctx.clearRect(0,0,width,height);

  const points = dataArray.length;
  const step = width / Math.max(1, points - 1);
  const baseY = height * 0.55;

  const gradStroke = ctx.createLinearGradient(0,0,width,0);
  gradStroke.addColorStop(0, 'rgba(180,155,250,0.95)');
  gradStroke.addColorStop(0.5, 'rgba(120,90,220,0.85)');
  gradStroke.addColorStop(1, 'rgba(200,160,255,0.95)');

  const gradFill = ctx.createLinearGradient(0,0,0,height);
  gradFill.addColorStop(0, 'rgba(180,155,250,0.22)');
  gradFill.addColorStop(1, 'rgba(120,90,220,0.03)');

  ctx.lineWidth = Math.max(2, Math.min(8, height * 0.06));
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  ctx.strokeStyle = gradStroke;
  ctx.fillStyle = gradFill;

  ctx.beginPath();
  for(let i=0;i<points;i++){
    const x = i * step;
    const amp = dataArray[i] / 255;
    const y = baseY
      - Math.sin(i * 0.28 + performance.now()/520) * (height * 0.12) * amp
      - Math.sin(i * 0.09 + performance.now()/320) * (height * 0.08) * amp
      - amp * (height * 0.18);

    if(i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.lineTo(width, height);
  ctx.lineTo(0, height);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
}

/* spawning photos (floating) */
function spawnPhoto(){
  const img = document.createElement('img');
  img.className = 'photo';
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–ø–∞—Å–Ω–æ–µ
  const randomIndex = Math.floor(Math.random() * photos.length);
  img.src = photos[randomIndex];
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  img.onerror = function() {
    this.src = fallbackImages[randomIndex];
    this.alt = '–ü–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (randomIndex + 1);
  };
  
  img.alt = '–§–æ—Ç–æ –î–∞—à–∏ ' + (randomIndex + 1);
  
  // keep inside viewport horizontally
  const left = Math.round(8 + Math.random() * (window.innerWidth - 16));
  img.style.left = left + 'px';
  document.body.appendChild(img);

  const start = performance.now();
  const dur = 2800 + Math.random() * 1700;
  function anim(){
    const t = (performance.now() - start) / dur;
    if(t < 1){
      const y = -120 + (window.innerHeight + 220) * Math.sin(t * Math.PI / 2);
      const scale = 0.9 + 0.45 * Math.sin(t * Math.PI);
      const rot = t * 360;
      const op = Math.sin(t * Math.PI);
      img.style.transform = `translate(-50%, ${y}px) scale(${scale}) rotate(${rot}deg)`;
      img.style.opacity = op;
      requestAnimationFrame(anim);
    } else {
      img.remove();
    }
  }
  requestAnimationFrame(anim);
}

/* snow */
function createSnow(){
  const d = document.createElement('div');
  d.className = 'snowflake';
  d.textContent = '‚ùÑ';
  d.style.left = Math.random() * 100 + 'vw';
  d.style.fontSize = (8 + Math.random() * 12) + 'px';
  d.style.animationDuration = (4 + Math.random() * 6) + 's';
  document.body.appendChild(d);
  setTimeout(()=>d.remove(), 10000);
}
setInterval(createSnow, 420);

/* ensure pointerdown covers touch & mouse, robust start */
async function startSequence(ev){
  if(started) return;
  started = true;
  ev && (ev.preventDefault && ev.preventDefault());
  setupAudio();
  try {
    if(audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
  } catch(e){ console.warn('resume failed', e); }

  try {
    const playPromise = bgm.play();
    if(playPromise && typeof playPromise.then === 'function'){
      await playPromise;
    }
  } catch(err){
    console.error('play failed', err);
    started = false;
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–≤—É–∫: –Ω–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∑–≤—É–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
    return;
  }

  // visuals
  try {
    if(!rafId) drawWave();
    if(!spawnInterval) spawnInterval = setInterval(spawnPhoto, 1400);
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
    if(particleInterval) clearInterval(particleInterval);
  } catch(e){ console.warn(e); }

  // hide flag/cookie/characters in sync
  setTimeout(()=>{
    flag.classList.add('hide');
    cookie.classList.add('hide');
    naruto.classList.add('hide');
    sakura.classList.add('hide');
    wanpis.classList.add('hide');
  }, 220);

  // hide button with smooth class
  playButton.classList.add('hidden');
  setTimeout(()=>{ playButton.style.display = 'none'; }, 900);
}

/* bind pointerdown and click fallback; pointerdown covers touch+mouse on modern browsers */
playButton.addEventListener('pointerdown', startSequence, {passive:false});
playButton.addEventListener('click', startSequence);

/* accessibility: allow space/enter when focused */
playButton.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startSequence(e); }
});

/* ensure canvas is resized immediately after play (some devices calculate sizes after layout) */
bgm.addEventListener('play', () => {
  setTimeout(resizeCanvas, 80);
});

/* cleanup on page hide */
document.addEventListener('visibilitychange', ()=> {
  if(document.visibilityState === 'hidden'){
    // stop heavy raf but keep audio playing (optional)
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
  } else {
    if(!rafId && analyser) drawWave();
  }
});

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
window.addEventListener('load', function() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  [flag, cookie, naruto, sakura, wanpis].forEach(img => {
    if(img.complete && img.naturalHeight === 0) {
      img.classList.add('fallback-image');
      img.style.display = 'none';
    }
  });
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
  particleInterval = setInterval(createCharacterParticles, 800);
});

console.log('–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –æ–∂–∏–¥–∞—é –∂–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (pointerdown) –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.');
</script>
</body>
</html>
